<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Basket Pro V8.2</title>
    <style>
        :root { --primary: #0984e3; --success: #00b894; --danger: #ff4757; --bg: #1a1a1a; --card: #2d3436; --text-muted: #a4b0be; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; text-align: center; background-color: var(--bg); color: white; margin: 0; padding: 0; padding-bottom: 90px; user-select: none; -webkit-tap-highlight-color: transparent; }
        
        /* NAVIGATION */
        .navbar { position: fixed; bottom: 0; width: 100%; background: #222; display: flex; justify-content: space-around; padding: 12px 0; border-top: 1px solid #333; z-index: 100; backdrop-filter: blur(10px); }
        .nav-item { color: #666; font-size: 0.75rem; display: flex; flex-direction: column; align-items: center; cursor: pointer; transition: 0.2s; }
        .nav-item span { font-size: 1.4rem; margin-bottom: 3px; }
        .nav-item.active { color: var(--primary); transform: translateY(-2px); }
        
        /* PAGES */
        .page { display: none; padding: 15px; animation: fadeIn 0.4s; max-width: 600px; margin: 0 auto; }
        .page.active { display: block; }

        /* HEADER USER */
        .user-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; background: #222; padding: 10px 15px; border-radius: 12px; border: 1px solid #333; }
        .logout-btn { background: none; border: 1px solid #444; color: #aaa; padding: 6px 12px; border-radius: 6px; font-size: 0.75rem; cursor: pointer; }

        /* STATS CARDS */
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; margin-bottom: 20px; }
        .stat-card { background: var(--card); padding: 15px 5px; border-radius: 12px; border: 1px solid #333; }
        .stat-num { font-size: 1.6rem; font-weight: 800; display: block; }
        .stat-lbl { font-size: 0.65rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; }

        /* SHOOT BUTTONS */
        .shoot-btns { display: flex; gap: 12px; height: 35vh; margin-bottom: 20px; }
        .btn-action { flex: 1; border: none; border-radius: 18px; font-size: 2rem; color: white; font-weight: bold; display: flex; flex-direction: column; align-items: center; justify-content: center; box-shadow: 0 5px 15px rgba(0,0,0,0.3); transition: transform 0.1s; }
        .btn-action:active { transform: scale(0.96); }
        .miss { background: linear-gradient(145deg, #e17055, var(--danger)); }
        .make { background: linear-gradient(145deg, var(--success), #00cec9); }

        /* TAB CONTROLS (Classement) */
        .tabs-control { display: flex; background: #333; border-radius: 8px; padding: 4px; margin-bottom: 20px; }
        .tab-btn { flex: 1; padding: 8px; border: none; background: none; color: #888; border-radius: 6px; font-size: 0.85rem; font-weight: bold; cursor: pointer; }
        .tab-btn.active { background: var(--primary); color: white; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }

        /* LIST ITEMS (Historique & Leaderboard) */
        .list-item { background: var(--card); margin-bottom: 12px; border-radius: 12px; overflow: hidden; border: 1px solid #333; text-align: left; transition: transform 0.2s; }
        .list-item:active { transform: scale(0.99); }
        
        .item-header { padding: 15px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; }
        .rank-badge { font-size: 1.2rem; width: 35px; text-align: center; }
        .user-info { flex-grow: 1; padding-left: 10px; }
        .user-name { font-weight: bold; font-size: 1.1rem; color: white; display: block; }
        .user-meta { font-size: 0.75rem; color: #888; }
        .score-badge { font-size: 1.3rem; font-weight: 800; color: var(--success); }

        /* DETAIL GRID (Tic/Croix) */
        .session-details { background: #222; padding: 10px; display: none; border-top: 1px solid #444; }
        .detail-row { display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px; font-size: 0.85rem; }
        .row-label { width: 60px; color: #aaa; font-weight: bold; }
        .row-grid { flex: 1; display: flex; gap: 4px; justify-content: center; }
        .shot-mark { width: 18px; height: 18px; border-radius: 4px; display: flex; align-items: center; justify-content: center; font-size: 10px; }
        .mark-yes { background: rgba(0, 184, 148, 0.2); color: var(--success); border: 1px solid var(--success); }
        .mark-no { background: rgba(255, 71, 87, 0.15); color: var(--danger); border: 1px solid var(--danger); }
        .row-total { width: 40px; text-align: right; font-weight: bold; }

        /* LOGIN */
        #login-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg); z-index: 999; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        input[type="text"] { width: 80%; max-width: 300px; padding: 15px; font-size: 1.1rem; border-radius: 12px; border: 2px solid #444; background: #333; color: white; text-align: center; margin-bottom: 20px; outline: none; }
        input:focus { border-color: var(--primary); }

        #voiceBtn { width: 100%; padding: 15px; background: #2d3436; color: white; border: 1px solid #444; border-radius: 12px; font-weight: bold; margin-bottom: 10px; display: flex; align-items: center; justify-content: center; gap: 10px; }
        #voiceBtn.listening { background: #e17055; border-color: #e17055; animation: pulse 1.5s infinite; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.7; } 100% { opacity: 1; } }
    </style>
</head>
<body>

    <div id="login-screen">
        <h1 style="margin-bottom: 30px;">üèÄ TEAM PRO V8</h1>
        <p style="color:#888; font-size:0.9rem; margin-bottom:20px;">Ton pseudo pour l'historique :</p>
        <input type="text" id="pseudo-input" placeholder="Ex: Jordan23">
        <button onclick="login()" style="padding:15px 40px; background:var(--success); border:none; border-radius:12px; color:white; font-weight:bold; font-size:1rem;">ENTRER</button>
    </div>

    <div id="page-shoot" class="page active">
        <div class="user-header">
            <div><span style="color:#888; font-size:0.8rem;">Joueur :</span> <strong id="user-display" style="color:white; margin-left:5px;">...</strong></div>
            <button class="logout-btn" onclick="logout()">Changer</button>
        </div>

        <div class="stats-grid">
            <div class="stat-card"><span class="stat-num" id="disp-series">1</span><span class="stat-lbl">S√©rie / 10</span></div>
            <div class="stat-card"><span class="stat-num" id="disp-shots" style="color:#74b9ff">0</span><span class="stat-lbl">Tirs / 10</span></div>
            <div class="stat-card"><span class="stat-num" id="disp-total">0%</span><span class="stat-lbl">Global</span></div>
        </div>

        <button id="voiceBtn" onclick="toggleVoice()"><span>üéôÔ∏è</span> <span id="voiceTxt">MICRO OFF</span></button>

        <div class="shoot-btns">
            <button class="btn-action miss" onclick="processInput(0)">‚ùå</button>
            <button class="btn-action make" onclick="processInput(1)">‚úÖ</button>
        </div>

        <button onclick="finishSession()" style="width:100%; padding:15px; background:var(--primary); border:none; border-radius:12px; color:white; font-weight:bold; margin-top:10px;">üíæ SAUVEGARDER LA S√âANCE</button>
    </div>

    <div id="page-profile" class="page">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
            <h2 id="profile-title" style="margin:0;">Mon Historique</h2>
            <button onclick="backToLeaderboard()" id="back-btn" style="display:none; background:#333; color:white; border:none; padding:5px 10px; border-radius:5px;">‚¨Ö Retour</button>
        </div>
        <div id="history-list">Chargement...</div>
    </div>

    <div id="page-rank" class="page">
        <h2 style="margin-bottom:15px;">üèÜ Hall of Fame</h2>
        
        <div class="tabs-control">
            <button class="tab-btn active" onclick="setRankMode('session', this)">Record Session (%)</button>
            <button class="tab-btn" onclick="setRankMode('serie', this)">Record S√©rie (/10)</button>
        </div>

        <div id="leaderboard-list">Chargement...</div>
    </div>

    <div class="navbar">
        <div class="nav-item active" onclick="switchTab('shoot', this)"><span>üèÄ</span>Tracker</div>
        <div class="nav-item" onclick="showMyProfile(this)"><span>üë§</span>Moi</div>
        <div class="nav-item" onclick="switchTab('rank', this)"><span>üèÜ</span>Classement</div>
    </div>

    <script>
        // =========================================================
        // TON LIEN EST DEJA INTEGRE ICI :
        const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxN68AC3tCN4caxHOUSfIJtOXTVDROLQ98d2PYEo6sN62qCGQP2-E3Ews931BPlfNx6tw/exec"; 
        // =========================================================

        let currentUser = localStorage.getItem('basket_user_v8');
        let allData = []; 
        let rankMode = 'session'; 

        // GAME STATE
        let currentSeries = 1;
        let shotsHistory = [];
        let sessionDataStr = []; 
        let totalMakes = 0;
        let totalShots = 0;
        const maxSeries = 10;
        const shotsPerSeries = 10;

        // INIT
        if (currentUser) startApp(currentUser);

        function login() {
            const val = document.getElementById('pseudo-input').value.trim();
            if (val) {
                localStorage.setItem('basket_user_v8', val);
                startApp(val);
            }
        }

        function startApp(pseudo) {
            currentUser = pseudo;
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('user-display').innerText = currentUser;
            document.getElementById('profile-title').innerText = "Historique de " + currentUser;
            loadDataFromCloud();
        }

        function logout() {
            if(confirm("Changer de joueur ?")) {
                localStorage.removeItem('basket_user_v8');
                location.reload();
            }
        }

        // --- GAME LOGIC ---
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function playSound(type) {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain); gain.connect(audioCtx.destination);
            osc.frequency.value = type === 1 ? 880 : 150; 
            if(type===1) osc.frequency.exponentialRampToValueAtTime(1760, audioCtx.currentTime + 0.1);
            else osc.frequency.linearRampToValueAtTime(100, audioCtx.currentTime + 0.2);
            gain.gain.value = 0.2; osc.start(); osc.stop(audioCtx.currentTime + 0.2);
        }

        function processInput(result) {
            if (currentSeries > maxSeries) return alert("S√©ance termin√©e !");
            
            playSound(result);
            shotsHistory.push(result);
            if (result === 1) totalMakes++;
            totalShots++;
            updateUI();

            if (shotsHistory.length >= shotsPerSeries) {
                let seriesStr = shotsHistory.join('');
                sessionDataStr.push(seriesStr);
                setTimeout(() => {
                    shotsHistory = [];
                    currentSeries++;
                    updateUI();
                    if(currentSeries > maxSeries) finishSession();
                }, 400);
            }
        }

        function updateUI() {
            document.getElementById('disp-series').innerText = (currentSeries > maxSeries ? "FIN" : currentSeries);
            document.getElementById('disp-shots').innerText = shotsHistory.length;
            let pct = totalShots > 0 ? Math.round((totalMakes / totalShots) * 100) : 0;
            document.getElementById('disp-total').innerText = pct + "%";
        }

        function finishSession() {
            if (totalShots === 0) return;
            if (!confirm("Sauvegarder la s√©ance ?")) return;

            let detailsFinal = sessionDataStr.join('|');
            let pct = Math.round((totalMakes / totalShots) * 100);

            const data = { pseudo: currentUser, reussis: totalMakes, total: totalShots, pct: pct, details: detailsFinal };

            fetch(GOOGLE_SCRIPT_URL, {
                method: 'POST', mode: 'no-cors',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            }).then(() => {
                alert("‚úÖ Sauvegard√© !");
                resetGame();
                showMyProfile(); 
            }).catch(() => alert("Erreur r√©seau"));
        }

        function resetGame() {
            currentSeries = 1; shotsHistory = []; sessionDataStr = []; totalMakes = 0; totalShots = 0;
            updateUI();
        }

        // --- DATA LOADING ---
        function loadDataFromCloud() {
            if(GOOGLE_SCRIPT_URL.includes("googleusercontent")) {
                alert("ERREUR CRITIQUE : Lien Google Script invalide (Lien temporaire).");
                return;
            }

            fetch(GOOGLE_SCRIPT_URL).then(res => res.json()).then(data => {
                // Tri par date
                allData = data.sort((a, b) => new Date(b.date) - new Date(a.date)); 
                renderLeaderboard();
                
                if(document.getElementById('page-profile').style.display === 'block') {
                    if(document.getElementById('back-btn').style.display === 'none') renderHistory(currentUser);
                }
            }).catch(err => {
                console.error(err);
                document.getElementById('leaderboard-list').innerHTML = "<p style='color:#e17055'>Erreur d'acc√®s aux donn√©es. V√©rifie que le Script Google est accessible √† 'Tout le monde'.</p>";
            });
        }

        // --- HISTORIQUE & DETAILS VISUELS ---
        function renderHistory(targetUser) {
            const list = document.getElementById('history-list');
            const userSessions = allData.filter(r => r.pseudo.toLowerCase() === targetUser.toLowerCase());
            
            if(userSessions.length === 0) {
                list.innerHTML = "<p style='color:#666; padding:20px;'>Aucune s√©ance trouv√©e.</p>";
                return;
            }

            list.innerHTML = userSessions.map((s, idx) => {
                let d = new Date(s.date);
                let dateStr = `${d.getDate()}/${d.getMonth()+1} √† ${d.getHours()}h${d.getMinutes()}`;
                
                // D√©tection format V8
                let isV8Format = s.details && (s.details.includes('|') || /^[01]+$/.test(s.details));

                let detailsHTML = "";
                if(isV8Format) {
                    let seriesArr = s.details.includes('|') ? s.details.split('|') : [s.details];
                    detailsHTML = seriesArr.map((seq, i) => {
                        let score = (seq.match(/1/g) || []).length;
                        let grid = seq.split('').map(char => 
                            `<div class="shot-mark ${char==='1'?'mark-yes':'mark-no'}">${char==='1'?'‚úî':'‚úñ'}</div>`
                        ).join('');
                        
                        return `<div class="detail-row">
                            <div class="row-label">S√©rie ${i+1}</div>
                            <div class="row-grid">${grid}</div>
                            <div class="row-total">${score}/${seq.length}</div>
                        </div>`;
                    }).join('');
                } else {
                    detailsHTML = `<p style="font-size:0.8rem; color:#888; text-align:center;">${s.details || "Pas de d√©tails"}</p>`;
                }

                return `
                <div class="list-item">
                    <div class="item-header" onclick="toggleDetails(${idx})">
                        <div class="user-info" style="padding:0;">
                            <span class="user-name">${dateStr}</span>
                            <span class="user-meta">${s.reussis}/${s.total} Tirs</span>
                        </div>
                        <div class="score-badge" style="color:${getColor(s.pct)}">${s.pct}%</div>
                    </div>
                    <div class="session-details" id="details-${idx}">
                        ${detailsHTML}
                    </div>
                </div>`;
            }).join('');
        }

        function toggleDetails(idx) {
            let el = document.getElementById(`details-${idx}`);
            el.style.display = el.style.display === 'block' ? 'none' : 'block';
        }

        function setRankMode(mode, btn) {
            rankMode = mode;
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            renderLeaderboard();
        }

        function renderLeaderboard() {
            const list = document.getElementById('leaderboard-list');
            let usersMap = {};
            
            allData.forEach(s => {
                let p = s.pseudo;
                if(!usersMap[p]) usersMap[p] = { pseudo: p, bestSession: 0, bestSerie: 0 };
                
                if(s.pct > usersMap[p].bestSession) usersMap[p].bestSession = s.pct;
                
                if(s.details) {
                    let cleanDetails = s.details;
                    if(/^[01|]+$/.test(cleanDetails)) {
                        let series = cleanDetails.includes('|') ? cleanDetails.split('|') : [cleanDetails];
                        series.forEach(seq => {
                            let score = (seq.match(/1/g) || []).length;
                            let normalizedScore = seq.length > 0 ? Math.round((score / seq.length) * 10) : 0;
                            if(seq.length < 5) normalizedScore = 0; 
                            if(normalizedScore > usersMap[p].bestSerie) usersMap[p].bestSerie = normalizedScore;
                        });
                    }
                }
            });

            let ranking = Object.values(usersMap);
            if(rankMode === 'session') ranking.sort((a, b) => b.bestSession - a.bestSession);
            else ranking.sort((a, b) => b.bestSerie - a.bestSerie);

            list.innerHTML = ranking.map((u, idx) => {
                let rank = idx + 1;
                let medal = rank===1?"ü•á":rank===2?"ü•à":rank===3?"ü•â":`#${rank}`;
                let scoreDisplay = rankMode === 'session' ? u.bestSession + "%" : u.bestSerie + "/10";
                let label = rankMode === 'session' ? "Meilleure S√©ance" : "Meilleure S√©rie";

                return `
                <div class="list-item">
                    <div class="item-header" onclick="viewUserProfile('${u.pseudo}')">
                        <div class="rank-badge">${medal}</div>
                        <div class="user-info">
                            <span class="user-name">${u.pseudo}</span>
                            <span class="user-meta">${label}</span>
                        </div>
                        <div class="score-badge">${scoreDisplay}</div>
                    </div>
                </div>`;
            }).join('');
        }

        function switchTab(tab, el) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.getElementById('page-' + tab).classList.add('active');
            if(el) el.classList.add('active');
            if(tab === 'rank') loadDataFromCloud();
        }

        function showMyProfile(el) {
            document.getElementById('profile-title').innerText = "Mon Historique";
            document.getElementById('back-btn').style.display = 'none';
            renderHistory(currentUser);
            switchTab('profile', el);
        }

        function viewUserProfile(targetPseudo) {
            document.getElementById('profile-title').innerText = "Historique de " + targetPseudo;
            document.getElementById('back-btn').style.display = 'inline-block';
            renderHistory(targetPseudo);
            switchTab('profile', null);
        }

        function backToLeaderboard() {
            switchTab('rank', document.querySelectorAll('.nav-item')[2]);
        }

        function getColor(pct) { return pct >= 70 ? '#00b894' : pct >= 50 ? '#e17055' : '#d63031'; }

        // --- VOCAL ---
        let recognition; let isListening = false;
        function toggleVoice() {
            if (!('webkitSpeechRecognition' in window)) return alert("Vocal non support√©");
            const btn = document.getElementById('voiceBtn');
            const txt = document.getElementById('voiceTxt');
            
            if(isListening) { 
                recognition.stop(); isListening=false; 
                btn.classList.remove('listening'); txt.innerText="MICRO OFF";
            } else {
                recognition = new webkitSpeechRecognition();
                recognition.lang = 'fr-FR'; recognition.continuous = false;
                recognition.onstart = () => { isListening=true; btn.classList.add('listening'); txt.innerText="JE T'√âCOUTE..."; };
                recognition.onend = () => { if(isListening && currentSeries<=maxSeries) recognition.start(); else { isListening=false; btn.classList.remove('listening'); txt.innerText="MICRO OFF"; }};
                recognition.onresult = (e) => {
                    let t = e.results[0][0].transcript.toLowerCase();
                    if(t.match(/oui|ok|yes|marqu√©/)) processInput(1);
                    if(t.match(/non|rat√©|no|zut/)) processInput(0);
                };
                recognition.start();
            }
        }
    </script>
</body>
</html>
